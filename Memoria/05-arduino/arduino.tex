\chapter{Desarrollo en Arduino}\label{chp-05}

Una parte imprescindible del proyecto es la programación del propio Arduino, que es el que centraliza
todo el control del sistema. La parte relacionada con el control del motor y la programación del encoder 
está bien documentada en el trabajo \cite{tapia}, mientras que para la medición del calibre se ha partido
de la web \cite{caliper} al igual que en el diseño electrónico ya comentado en el capítulo \ref{chp-03}.

\section{Diagrama de flujo}

\begin{figure}[hbtp]
    \centering
    \includegraphics[height=0.5\textheight]{05-arduino/diagramaflujo.pdf}
    \caption{Diagrama de flujo del programa}
    \label{fig:diagramaflujo}
    \end{figure}

En el diagrama de la figura \ref{fig:diagramaflujo} se observa los distintos estados por los que pasa el 
programa. En primer lugar, se realiza una comprobación de los estados de microcontrolador y local para 
configurar los pines como corresponde. En caso de que no haya microcontrolador, se configurarán los pines
IN3, IN4 y ENB como entradas y el dispositivo esperará a que se salga de dicho modo, manteniéndose en estado 
"f". Si se configura como remoto, el Arduino entrará en estado "r" (remoto) y comprobará continuamente si se
recibe una orden por parte del controlador del ABB para realizar dicho movimiento.

El caso que tiene más estados intermedios es el modo local, ya que requiere varios menús dentro de la pantalla
para la interacción con el usuario. En este modo de funcionamiento se avanza en el menú con el botón enter y se
retrocede con el botón escape. Tras realizar las configuraciones del sistema, el sistema entrará en estado 
"i" (inicial), mostrado un mensaje de bienvenida en el LCD y esperando al botón enter para avanzar de menú. Una 
vez pulsado enter, se pasa al modo selección de avance absoluto o discreto, estado "s". En este estado, mediante
las flechas de selección se cambia entre avance discreto y avance absoluto. Una vez avanzado al siguiente menú, 
entramos en el modo selección de distancia de movimiento "d". En este modo, mediante las flechas se irá incrementando
o disminuyendo la posición final deseada. Por último, se tomará toda la información recibida por el usuario para 
pasar al estado de motor en movimiento "m".

Independientemente si se accede al estado "m" mediante modo local o remoto, la cinta se moverá hasta la posición 
deseada mediante el mismo algoritmo. Primero se aproxima la pieza a la posición final avanzando a velocidad constante
para posicionar finalmente la pieza mediante un PID. Una vez terminada la operación, vuelve al modo inicial para 
seguir esperando órdenes.

En cualquier caso, si en cualquier momento se pulsa la seta de emergencia, la cinta parará automáticamente y se entrará
en estado emergencia "e". En este modo no se podrá realizar ninguna acción hasta que se desarme la seta de emergencia.

\section{Programa final}

La pruebecita



\input{05-arduino/mainh.tex}

blablabla

\input{05-arduino/maincpp.tex}